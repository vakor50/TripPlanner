<!DOCTYPE html>
<html>
<!-- TODO List -->

<!-- 

Implement cool data structures 

Make each purchase to be an object so all the information is grouped together 

!!!!  remove html tags from input
	used function isHTML()

!!!!  remove white space from input
	ran regex in function toName

!!!!  Strip $ and , from money input
	set input type to "number"

add option to delete users
	!!!! delete from list of people
	delete from header of table
	delete purchase if purchaser
	remove person from debtTable

!!!!  auto capitalize names and types of purchase
	completed in toName

Hit enter to enter into input boxes

!!!!  numbers that are too large or too small
	added conditions in addPurchase section

debtTable[c][purchaser[z]] += owed;	on this line, else might not be necessary?

get better naming conventions

!!!! if a person doesn't owe anyone anything, they aren't shown
	based around var inner in loops to print in calculate

-->

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE-edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!-- The above 3 meta tages *must* come first in the head; any other head content must come *after* these tags -->
	<meta name="description" content="">
	<meta name="author" content="">

	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<style>
		#myList {
			padding-top: 25px;
			padding-bottom: 25px;
		}

		table {
			table-layout: fixed;
		}
	</style>

	<!-- Include jQuery -->
	<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body>
	<nav class="navbar navbar-default navbar-static-top">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
					<span class="sr-only">Toggle navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="#">Breakfast</a>
			</div>
			<div id="navbar" class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li class="active"><a href="#">Home</a></li>
					<li><a href="#about">About</a></li>
					<li><a href="#contact">Contact</a></li>
					<li class="dropdown">
						<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="#">Action</a></li>
							<li><a href="#">Another action</a></li>
							<li><a href="#">Something else here</a></li>
							<li role="separator" class="divider"></li>
							<li class="dropdown-header">Nav header</li>
							<li><a href="#">Separated link</a></li>
							<li><a href="#">One more separated link</a></li>
						</ul>
					</li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="../navbar/">Default</a></li>
					<li class="active"><a href="./">Static top <span class="sr-only">(current)</span></a></li>
					<li><a href="../navbar-fixed-top/">Fixed top</a></li>
				</ul>
			</div><!--/.nav-collapse -->
		</div>
	</nav>

	<div class="container">

		<!-- List with IDs so they can be referenced in JS -->

		<ul id="myList" class="list-group">
			<!-- <li class="list-group-item">Sample Item 1</li> -->
			<li class="list-group-item" style="text-align: center; text-decoration: underline; font-weight: bold;">Trip Participants</li>
		</ul>


		<input id="myText">
		<button id="addItemButton">Add Person</button>

		<hr>

		<!-- Drop down menu for selecting purchaser -->
		<div>
			<select id="mySelect">
				<option>Select Purchaser</option>
			</select>
		</div>

		<!-- Input boxes for type and amount of purchase -->
		<div>
			Type of purchase: <input id="myType">
			<br>
			Purchase amount: <input id="myAmt" type="number">
			<br>
		</div>

		<!-- Add purchase button -->
		<button id="addPurchaseButton">Add Purchase</button>
		
		<hr>

		<table class="table">
			<thead>
				<tr id="myHeader">
					<th>#</th>
					<th>Item</th>
					<th>Purchaser</th>
					<th>Amount</th>
				</tr>
			</thead>
			<tbody id="myTBody">

			</tbody>
		</table>

		<!-- Calculate button -->
		<button id="calculate">Calculate</button>

		<hr>

		<div id="output" class="row">

		</div>

		<script type="text/javascript">
			var people= [];
			var purchases = [];
			var purchaser = [];
			var debtTable = [];
			var numPeople = 0;
			var numPurch = 0;
			var isDup = false;

			// capitalizes first letter of each word
			// eliminates extra white space
			function toName(s) {
				s = s.replace( /[\s\n\r]+/g, ' ' );
				var words = s.split(" ");
				//console.log(words);
				var final = "";
				for (var i = 0; i < words.length; i++) {

					final += words[i].charAt(0).toUpperCase() 
					if(words[i].length > 1)
						final += words[i].substring(1, words[i].length).toLowerCase();
					final += " ";
				}

				return final;
				
			}

			// returns true if string contains html tags
			function isHTML(str) {
				var a = document.createElement('div');
				a.innerHTML = str;
				for (var c = a.childNodes, i = c.length; i--; ) {
					if (c[i].nodeType == 1) return true; 
				}
				return false;
			}

			// delete instances of this user
			function rem(id) {
				// removes person from the list of people
				var elem = document.getElementById('person' + id);
				elem.parentNode.removeChild(elem);
			}


			// When the element with id="AddItemButton" is clicked
			// Add person
			$('#addItemButton').click(function() {

				// Remove any html or white space on input, capitalize the words
				var name = $('#myText').val().trim();
				if(isHTML(name)) {
					name = $(name)[0].textContent;
				}
				name = toName(name).trim();
				

				// make sure there is text in the name field
				if(document.getElementById("myText").value == 0) {
					alert("Please enter a name");
				}
				else {
					for(var x = 0; x < numPeople; x++)
					{
						// if (people[x] == $('#myText').val()) {
						if (people[x] == name) {
							alert("Duplicate name!");
							isDup = true;
						}
					}
					if(!isDup) {

						// Append the new person to the element with id="myList"
						$('#myList').append('<li class="list-group-item" id="person' + numPeople + '">' 
							+ (numPeople + 1) + ') ' + name + 
							'<button id="del delete-' + numPeople + '" onclick="rem(' + numPeople + ')">Delete</button></li>');

						$('#myHeader').append('<th>' + name + '</th>');

						$('#mySelect').append('<option value="' + numPeople + '">' + name + '</option>');

						// if purchases exist but a new person is added, add this person to the table
						if(numPurch > 0) {
							console.log("purchases exist");
							// iterate through existing purchases
							for(var i = 0; i < numPurch; i++) {
								$('#purchase' + i).append('<td><input type="checkbox" id="check' + i + '-' + numPeople + '"></td>');
							}
						}

						// add person to list of people
						people.push(name);
						console.log(people);

						// add a row for this person to debtTable
						debtTable[numPeople] = [];

						numPeople = numPeople + 1;

						// reset input box
						document.getElementById("myText").value = "";
					}
				}

				isDup = false;
			});


			// When purchase button clicked add information to the table
			$('#addPurchaseButton').click(function() {

				var amount = $('#myAmt').val();

				// remove excess HTML or blank space, then capitalize
				var type = $('#myType').val().trim();
				if(isHTML(type)) {
					type = $(type)[0].textContent;
				}
				type = toName(type).trim();

				// name of the purchaser
				var selectedPurchaser = document.getElementById("mySelect");
				var strUser = selectedPurchaser.options[selectedPurchaser.selectedIndex].text;

				var row = '<tr id="purchase' + numPurch + '"><td>' + (numPurch + 1) + '</td>';
				row = row + '<td>' + type + '</td>';
				row = row + '<td>' + strUser + '</td>';
				row = row + '<td>' + '$' + parseFloat(amount).toFixed(2) + '</td>';

				// check that entries are valid
				if(document.getElementById("myType").value == 0) {
					alert("Please enter a purchase type");
				}
				else if (document.getElementById("myAmt").value == 0) {
					alert("Please enter a purchase amount");
				}
				else if (document.getElementById("mySelect").value == "Select Purchaser") {
					alert("Please select a purchaser");
				}
				else if (amount > 999999999) {
					alert("Number is too large");
				}
				else if (amount < 0) {
					alert("We don't accept negative numbers");
				}
				else { // entries are valid

					// add checkboxes for every person for this purchase
					for(var n = 0; n < numPeople; n++) {
						// if the purchaser and person are same, check the box
						if(strUser == people[n].trim()) {
							purchaser[numPurch] = n;
							row = row + '<td><input type="checkbox" id="check' + numPurch + '-' + n + '" checked></td>';
						}
						else {
							row = row + '<td><input type="checkbox" id="check' + numPurch + '-' + n + '"></td>';
						}
					}
					row = row + '</tr>';

					$('#myTBody').append(row);
					purchases[numPurch] = amount;
					numPurch = numPurch + 1;
				}

				// if a new purchase is added, the calculated information needs to be changed
				document.getElementById("output").innerHTML = "";

			});


			// Calculate totals for each person when Calculate button is clicked
			$('#calculate').click(function() {
				// initialize all values in debtTable to 0
				// previous calculations won't carry over
				for(var i = 0; i < numPeople; i++) {
					for(var j = 0; j < numPeople; j++) {
						debtTable[i][j] = 0;
					}
				}

				// iterate through each purchase
				for (var z = 0; z < numPurch; z++) {
					
					// get the amount of the purchase
					var amount = purchases[z];

					// find out how many people are checked
					var countChecked = 0;
					for(var checked = 0; checked < numPeople; checked++) {
						var x = document.getElementById("check" + z + "-" + checked);
						if(x.checked) {
							countChecked++;
						}
					}

					// calculate how much the number of people owe to the pruchaser
					var owed = amount / countChecked;

					// update values in debtTable
					for(var c = 0; c < numPeople; c++) {
						var x = document.getElementById("check" + z + "-" + c);

						// if the box is checked, that person owes money
						if(x.checked) {
							if(debtTable[c][purchaser[z]] >= 0) {
								debtTable[c][purchaser[z]] += owed;
							} else {
								debtTable[c][purchaser[z]] = owed;
							}

							console.log(purchaser[z] + " - " + c + " = " + owed);
						} else {
							// debtTable = 0
						}
					}
				}

				// reset div where output for each person is put
				document.getElementById("output").innerHTML = "";

				// iterate through each person that owes money
				for(var row = 0; row < numPeople; row++) {
					console.log(debtTable[row]);
					var out = '<div class="col-lg-4"><h3>' + people[row] + ' owes:</h3><ul>';
					var inner = '';

					// iterate through each person they owe money to
					// set cells to 0 if the information is redundant
					for(var col = 0; col < numPeople; col++) {
						if(row != col && debtTable != 0) {
							// compare (row,col) to (col,row) 
							// because the purchaser and ower are swapped, the difference shown
							if(debtTable[row][col] > 0) {
								if (debtTable[row][col] > debtTable[col][row]) {
									debtTable[row][col] -= debtTable[col][row];
									debtTable[col][row] = 0;
								} else if (debtTable[row][col] < debtTable[col][row]) {
									debtTable[col][row] -= debtTable[row][col];
									debtTable[row][col] = 0;
								} else if (debtTable[row][col] == debtTable[col][row]) {
									debtTable[col][row] = 0;
									debtTable[row][col] = 0;
								}
							}
						}
					}

					// iterate through each person they owe money to
					// add the <li> for each person owed money
					for(var c = 0; c < numPeople; c++) {
						if(row != c && debtTable[row][c] != 0) {
							inner += '<li>' + people[c] + ' $' + parseFloat(debtTable[row][c]).toFixed(2) + '</li>';
						}
					}

					// if no money is owed to anyone, don't print the person
					if (inner != '') {
						out += inner + '</ul></div>';
					} else {
						out = '';
					}
					$('#output').append(out);
				}

			});

		</script>
		



	</div>


</body>


</html>